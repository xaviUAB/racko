<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNO Game: Multijugador.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f3e8; }

        /* UNO Card Styles */
        .uno-card {
            width: 70px;
            height: 100px;
            border-radius: 8px;
            border: 3px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
        }
        .uno-card.card-sm {
             width: 50px;
             height: 70px;
             font-size: 1.5rem;
        }

        .uno-card:hover:not(.card-back) {
            transform: translateY(-5px);
        }
        .uno-card.playable {
            box-shadow: 0 0 15px 5px #fef08a; /* Yellow glow */
            transform: translateY(-5px);
        }
        .uno-card .card-symbol {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 1rem;
            font-weight: bold;
        }

        .card-red { background-color: #EF4444; }
        .card-yellow { background-color: #F59E0B; }
        .card-green { background-color: #10B981; }
        .card-blue { background-color: #3B82F6; }
        .card-black { background-color: #1F2937; }
        
        .card-back {
            background: #1F2937;
            background-image: radial-gradient(white 2px, transparent 0), radial-gradient(white 2px, transparent 0);
            background-size: 15px 15px;
            background-position: 0 0, 7.5px 7.5px;
        }

        /* Player Hand Styles */
        #my-hand .uno-card {
            margin-right: -30px;
        }
        #my-hand .uno-card:last-child {
            margin-right: 0;
        }

        .current-player-indicator {
            box-shadow: 0 0 0 4px #f59e0b;
        }
        
        #color-picker-modal .color-swatch {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #color-picker-modal .color-swatch:hover {
            transform: scale(1.1);
        }
        
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "firebase/": "https://aistudiocdn.com/firebase@^12.5.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.552.0"
  }
}
</script>
</head>
<body class="p-4 sm:p-6">
    
    <!-- UI DEL JOC -->
    <div class="max-w-6xl mx-auto p-4 bg-white rounded-xl shadow-2xl">
        
        <!-- Header i Estat -->
        <header class="mb-4 flex flex-col sm:flex-row justify-between items-center pb-4 border-b">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2 sm:mb-0">UNO <span class="text-indigo-600 text-base">v. Multiplayer</span></h1>
            <div id="game-status" class="text-sm font-semibold">Carregant...</div>
        </header>

        <!-- DEBUG & DIAGN√íSTIC -->
        <div id="debug-and-host-tools" class="text-xs p-2 mb-4 bg-yellow-50 rounded-lg border border-yellow-200 flex flex-col sm:flex-row justify-between items-center">
             <div class="mb-2 sm:mb-0">
                <h4 class="font-bold text-yellow-800 mb-1">Panell de Diagn√≤stic (Debug)</h4>
                <span id="user-id-display" class="block text-gray-600">ID d'Usuari: <span class="font-mono text-xs">Carregant...</span></span>
                <span id="game-id-display" class="block text-gray-600">ID de Partida Activa: <span id="game-id-value" class="font-bold text-red-600">N/A</span></span>
            </div>
            <div id="host-reset-area" class="mt-2 sm:mt-0 w-full sm:w-auto"></div>
        </div>

        <!-- √Ärea Principal de l'Aplicaci√≥ (Lobby o Joc) -->
        <div id="main-container">
            <div id="game-container" class="mt-4">
                <p class="text-center text-gray-600">Carregant l'estat de la partida...</p>
            </div>
            
            <!-- √Ärea de Joc Activa -->
            <div id="game-active-area" class="mt-6 hidden flex flex-col items-center">

                <!-- √Ärea d'Oponents -->
                <div id="opponents-area" class="w-full flex justify-around mb-6">
                    <!-- Les mans dels oponents es renderitzaran aqu√≠ -->
                </div>

                <!-- Zones de Munt i Descart -->
                <div class="flex justify-center items-center space-x-8 mb-6 p-4 bg-gray-50 rounded-lg shadow-inner">
                    <div class="flex flex-col items-center">
                        <h4 class="font-bold text-gray-700 mb-2 flex items-center">Munt (<span id="draw-pile-count">0</span>)</h4>
                        <div id="draw-pile" class="uno-card card-back card-sm cursor-pointer" onclick="window.gameFunctions.drawCardFromPile()"></div>
                    </div>
                    
                    <div class="flex flex-col items-center">
                        <h4 class="font-bold text-gray-700 mb-2 flex items-center">Descarts</h4>
                        <div id="discard-pile-container" class="p-1 rounded-lg">
                           <div id="discard-pile" class="uno-card card-sm"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Missatge/Acci√≥ de Torn -->
                <div id="action-area" class="mb-6 p-3 rounded-xl text-center w-full max-w-lg">
                    <!-- Bot√≥ de 'Comen√ßar Partida' o missatge de torn -->
                </div>
                
                <!-- La teva M√† -->
                <div class="bg-indigo-50 p-4 rounded-xl shadow-inner mb-2 w-full">
                    <h3 id="my-player-name" class="text-xl font-bold text-indigo-700 mb-3 text-center">La Teva M√†</h3>
                    <div id="my-hand" class="flex justify-center items-center min-h-[110px]">
                        <!-- Les teves cartes es renderitzaran aqu√≠ -->
                    </div>
                </div>

                <!-- Puntuacions -->
                <div class="w-full mt-4">
                    <h3 class="text-xl font-bold text-gray-700 mb-3">Puntuaci√≥ Global</h3>
                    <div id="all-players-score" class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                        <!-- Puntuacions de tots els jugadors -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h4 id="modal-title" class="text-2xl font-bold mb-3 text-red-600">T√≠tol del Modal</h4>
            <p id="modal-message" class="text-gray-700 mb-4">Missatge del modal.</p>
            <div id="modal-actions" class="flex flex-col space-y-2">
                <button id="modal-confirm-btn" class="hidden w-full py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Confirmar</button>
                <button id="modal-close-btn" onclick="window.gameFunctions.closeModal()" class="w-full py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-700">Ent√®s</button>
            </div>
        </div>
    </div>

    <div id="color-picker-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <h4 class="text-2xl font-bold mb-4 text-center">Tria un color</h4>
            <div class="flex justify-center space-x-4">
                <div class="color-swatch card-red" onclick="window.gameFunctions.chooseColor('red')"></div>
                <div class="color-swatch card-yellow" onclick="window.gameFunctions.chooseColor('yellow')"></div>
                <div class="color-swatch card-green" onclick="window.gameFunctions.chooseColor('green')"></div>
                <div class="color-swatch card-blue" onclick="window.gameFunctions.chooseColor('blue')"></div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, updateDoc, arrayUnion, runTransaction, getDocs, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const FIREBASE_SETTINGS = { 
            apiKey: "AIzaSyDQWCvBru356guXE3tAB6R2VjOsqaFHttY",
            authDomain: "rack-o-16931.firebaseapp.com",
            projectId: "rack-o-16931",
            storageBucket: "rack-o-16931.firebasestorage.app",
            messagingSenderId: "127219641303",
            appId: "1:127219641303:web:285e63d0bfecb9da4db992",
            measurementId: "G-1EQ8RBNL1J"
        }; 
        const MANUAL_APP_ID_FOR_PATH = "rack-o-16931";

        const isCanvasEnvironment = typeof __firebase_config !== 'undefined';
        const appId = isCanvasEnvironment ? (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id') : MANUAL_APP_ID_FOR_PATH;
        const firebaseConfig = isCanvasEnvironment ? JSON.parse(__firebase_config) : FIREBASE_SETTINGS;
        const initialAuthToken = isCanvasEnvironment ? (typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null) : null;

        let app, db, auth;
        let userId = null;
        let gameId = null;
        let gameState = null;
        let unsubscribeGame = null;

        // UNO Constants
        const COLORS = ['red', 'yellow', 'green', 'blue'];
        const VALUES = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'skip', 'reverse', 'draw2'];
        const WILD_VALUES = ['wild', 'wild_draw4'];
        const CARDS_PER_PLAYER = 7;
        const WINNING_SCORE = 500;
        const MAX_PLAYERS = 4;

        // --- AUTH & FIREBASE INIT ---
        const initFirebase = async () => {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').innerHTML = `ID d'Usuari: <span class="font-mono text-xs">${userId}</span>`;
                    loadLastGame();
                } else if (isCanvasEnvironment && initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            });
        };

        // --- CORE UNO LOGIC ---
        const createUnoDeck = () => {
            let deck = [];
            for (const color of COLORS) {
                for (const value of VALUES) {
                    deck.push({ color, value });
                    if (value !== '0') deck.push({ color, value });
                }
            }
            for (let i = 0; i < 4; i++) {
                deck.push({ color: 'black', value: 'wild' });
                deck.push({ color: 'black', value: 'wild_draw4' });
            }
            return shuffleArray(deck);
        };
        
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };
        
        const isCardPlayable = (card, topDiscard, currentColor) => {
            if (card.color === 'black') return true;
            if (card.color === currentColor) return true;
            if (card.value === topDiscard.value) return true;
            return false;
        };

        const calculateScore = (players, winnerId) => {
            let roundScore = 0;
            for (const player of players) {
                if (player.id === winnerId) continue;
                for (const card of player.hand) {
                    if (['wild', 'wild_draw4'].includes(card.value)) {
                        roundScore += 50;
                    } else if (['skip', 'reverse', 'draw2'].includes(card.value)) {
                        roundScore += 20;
                    } else {
                        roundScore += parseInt(card.value, 10);
                    }
                }
            }
            return roundScore;
        };
        
        // --- GAME STATE MANAGEMENT ---
        const getGameRef = (id) => doc(db, 'artifacts', appId, 'public', 'data', 'uno_games', id);

        const loadLastGame = async () => {
            const lastGameId = localStorage.getItem('uno_active_game_id');
            if (lastGameId) {
                try {
                    const gameRef = getGameRef(lastGameId);
                    const gameDoc = await getDoc(gameRef);

                    if (gameDoc.exists()) {
                        const gameData = gameDoc.data();
                        if (gameData.playerIds && gameData.playerIds.includes(userId)) {
                            startListeningToGame(lastGameId);
                            return;
                        }
                    }
                    // Game doesn't exist or user not in it, it's a stale ID.
                    localStorage.removeItem('uno_active_game_id');
                } catch (error) {
                    console.error("Error reconnecting to game:", error);
                    localStorage.removeItem('uno_active_game_id');
                }
            }
            // If no gameId in storage or if reconnection failed, render the lobby.
            renderLobby();
        };


        const startListeningToGame = (id) => {
            if (unsubscribeGame) unsubscribeGame();
            gameId = id;
            localStorage.setItem('uno_active_game_id', id);
            document.getElementById('game-id-value').textContent = gameId;
            unsubscribeGame = onSnapshot(getGameRef(gameId), (doc) => {
                if (doc.exists()) {
                    gameState = doc.data();
                    renderGame(gameState);
                } else {
                    resetLobbyState("The game was deleted.");
                }
            }, (error) => {
                console.error("Snapshot error:", error);
                resetLobbyState("Connection error.");
            });
        };

        const resetLobbyState = (message = "") => {
            if (unsubscribeGame) {
                unsubscribeGame();
                unsubscribeGame = null;
            }
            gameId = null;
            gameState = null;
            localStorage.removeItem('uno_active_game_id');
            document.getElementById('game-id-value').textContent = 'N/A';
            renderLobby(message);
        };

        const createGame = async (playerName) => {
            const uniqueId = String(Math.floor(1000 + Math.random() * 9000));
            const newPlayer = { id: userId, name: playerName, hand: [], score: 0 };
            const newGameData = {
                status: 'lobby',
                maxPlayers: MAX_PLAYERS,
                playerIds: [userId],
                players: [newPlayer],
                deck: [],
                discardPile: [],
                turn: null,
                currentColor: null,
                turnDirection: 1, // 1 for clockwise, -1 for counter-clockwise
                messages: [`${playerName} created the game.`],
                unoCalled: {}
            };
            try {
                await setDoc(getGameRef(uniqueId), newGameData);
                startListeningToGame(uniqueId);
            } catch (error) {
                showModal("Error", "Could not create game.");
            }
        };

        const joinGame = async (id, playerName) => {
            const gameRef = getGameRef(id);
            try {
                await runTransaction(db, async (transaction) => {
                    const doc = await transaction.get(gameRef);
                    if (!doc.exists()) throw new Error("Game not found.");
                    const game = doc.data();
                    if (game.status !== 'lobby') throw new Error("Game has already started.");
                    if (game.playerIds.length >= game.maxPlayers) throw new Error("Game is full.");
                    const newPlayer = { id: userId, name: playerName, hand: [], score: 0 };
                    transaction.update(gameRef, {
                        playerIds: arrayUnion(userId),
                        players: arrayUnion(newPlayer),
                        messages: arrayUnion(`${playerName} joined.`),
                    });
                });
                startListeningToGame(id);
            } catch (error) {
                showModal("Join Error", error.message);
            }
        };

        const startGame = async () => {
            if (gameState.players.length < 2) {
                return showModal("Error", "Necessites com a m√≠nim 2 jugadors per comen√ßar.");
            }
            const gameRef = getGameRef(gameId);
            try {
                await runTransaction(db, async (transaction) => {
                    const doc = await transaction.get(gameRef);
                    const game = doc.data();
                    
                    let deck = createUnoDeck();
                    let players = game.players;

                    players.forEach(p => {
                        p.hand = deck.splice(0, CARDS_PER_PLAYER);
                    });

                    let topDiscard;
                    do {
                        topDiscard = deck.pop();
                        if (topDiscard.value === 'wild_draw4') {
                            deck.push(topDiscard);
                            deck = shuffleArray(deck);
                        }
                    } while (topDiscard.value === 'wild_draw4');
                    
                    const startingPlayerIndex = 0; // First player starts
                    
                    const updates = {
                        status: 'playing',
                        players,
                        deck,
                        discardPile: [topDiscard],
                        currentColor: topDiscard.color,
                        turn: players[startingPlayerIndex].id,
                        messages: arrayUnion("The game has started! Good luck."),
                    };

                    // Apply effect of first card if it's special
                    let turnIndex = startingPlayerIndex;
                    if (topDiscard.value === 'skip') {
                        turnIndex = (startingPlayerIndex + game.turnDirection + players.length) % players.length;
                    } else if (topDiscard.value === 'reverse') {
                        updates.turnDirection = -1;
                        turnIndex = (startingPlayerIndex + updates.turnDirection + players.length) % players.length;
                    } else if (topDiscard.value === 'draw2') {
                        players[turnIndex].hand.push(...deck.splice(0, 2));
                        turnIndex = (startingPlayerIndex + game.turnDirection + players.length) % players.length;
                    }
                    
                    updates.turn = players[turnIndex].id;
                    if (topDiscard.value === 'wild') {
                        // If first card is wild, creator chooses color. We'll just default to red for simplicity.
                        updates.currentColor = 'red'; 
                        updates.messages.push(`${players[0].name} (creator) chose RED as starting color.`);
                    }

                    transaction.update(gameRef, updates);
                });
            } catch (error) {
                console.error("Error starting game: ", error);
                showModal("Error", "Could not start game. " + error.message);
            }
        };
        
        const playCard = async (cardIndex) => {
            if (gameState.turn !== userId) return;
            
            const player = gameState.players.find(p => p.id === userId);
            const card = player.hand[cardIndex];
            const topDiscard = gameState.discardPile[gameState.discardPile.length - 1];
            
            if (!isCardPlayable(card, topDiscard, gameState.currentColor)) {
                return showModal("Invalid Move", "You cannot play this card.");
            }
            
            if (card.color === 'black') {
                document.getElementById('color-picker-modal').dataset.cardIndex = cardIndex;
                document.getElementById('color-picker-modal').classList.remove('hidden');
                return;
            }

            await executePlayCardTransaction(cardIndex, card.color);
        };

        const chooseColor = (color) => {
            const cardIndex = document.getElementById('color-picker-modal').dataset.cardIndex;
            document.getElementById('color-picker-modal').classList.add('hidden');
            executePlayCardTransaction(parseInt(cardIndex), color);
        };

        const executePlayCardTransaction = async (cardIndex, chosenColor) => {
            const gameRef = getGameRef(gameId);
            try {
                await runTransaction(db, async (transaction) => {
                    const doc = await transaction.get(gameRef);
                    const game = doc.data();
                    
                    const playerIndex = game.players.findIndex(p => p.id === userId);
                    const card = game.players[playerIndex].hand[cardIndex];
                    
                    // --- Update Player Hand and Discard Pile ---
                    game.players[playerIndex].hand.splice(cardIndex, 1);
                    game.discardPile.push(card);
                    
                    let nextPlayerIndex = (playerIndex + game.turnDirection + game.players.length) % game.players.length;
                    
                    // --- Handle Card Effects ---
                    game.currentColor = chosenColor;
                    let message = `${game.players[playerIndex].name} played a card.`;
                    
                    if (card.value === 'draw2') {
                        game.players[nextPlayerIndex].hand.push(...game.deck.splice(0, 2));
                        message = `${game.players[playerIndex].name} played a Draw 2! ${game.players[nextPlayerIndex].name} draws 2 and is skipped.`;
                        nextPlayerIndex = (nextPlayerIndex + game.turnDirection + game.players.length) % game.players.length;
                    } else if (card.value === 'skip') {
                        message = `${game.players[playerIndex].name} played a Skip! ${game.players[nextPlayerIndex].name} is skipped.`;
                        nextPlayerIndex = (nextPlayerIndex + game.turnDirection + game.players.length) % game.players.length;
                    } else if (card.value === 'reverse') {
                        game.turnDirection *= -1;
                        message = `${game.players[playerIndex].name} played a Reverse! Direction is now reversed.`;
                        nextPlayerIndex = (playerIndex + game.turnDirection + game.players.length) % game.players.length;
                    } else if (card.value === 'wild') {
                        message = `${game.players[playerIndex].name} played a Wild and chose ${chosenColor.toUpperCase()}.`;
                    } else if (card.value === 'wild_draw4') {
                        game.players[nextPlayerIndex].hand.push(...game.deck.splice(0, 4));
                        message = `${game.players[playerIndex].name} played a Wild Draw 4, chose ${chosenColor.toUpperCase()}! ${game.players[nextPlayerIndex].name} draws 4 and is skipped.`;
                        nextPlayerIndex = (nextPlayerIndex + game.turnDirection + game.players.length) % game.players.length;
                    }
                    
                    // --- Win Condition Check ---
                    if (game.players[playerIndex].hand.length === 0) {
                        const roundScore = calculateScore(game.players, userId);
                        game.players[playerIndex].score += roundScore;
                        
                        if(game.players[playerIndex].score >= WINNING_SCORE) {
                             game.status = 'finished';
                             game.winnerId = userId;
                             message = `üéâ ${game.players[playerIndex].name} wins the game with ${game.players[playerIndex].score} points! üéâ`;
                        } else {
                            game.status = 'finished_hand';
                            message = `üèÜ ${game.players[playerIndex].name} wins the round and gets ${roundScore} points!`;
                        }
                    }

                    if(game.unoCalled[userId]) game.unoCalled[userId] = false;
                    
                    transaction.update(gameRef, {
                        players: game.players,
                        deck: game.deck,
                        discardPile: game.discardPile,
                        turn: game.status === 'playing' ? game.players[nextPlayerIndex].id : null,
                        turnDirection: game.turnDirection,
                        currentColor: game.currentColor,
                        status: game.status,
                        winnerId: game.winnerId,
                        messages: arrayUnion(message),
                        unoCalled: game.unoCalled,
                    });
                });
            } catch (error) {
                console.error("Error playing card: ", error);
                showModal("Error", "Could not play card. " + error.message);
            }
        };

        const drawCardFromPile = async () => {
             if (gameState.turn !== userId) return;
             const gameRef = getGameRef(gameId);
             try {
                await runTransaction(db, async (transaction) => {
                    const doc = await transaction.get(gameRef);
                    const game = doc.data();

                    if (game.deck.length === 0) {
                        // Reshuffle discard pile into deck
                        const topCard = game.discardPile.pop();
                        game.deck = shuffleArray(game.discardPile);
                        game.discardPile = [topCard];
                    }

                    const playerIndex = game.players.findIndex(p => p.id === userId);
                    const drawnCard = game.deck.pop();
                    game.players[playerIndex].hand.push(drawnCard);
                    
                    const nextPlayerIndex = (playerIndex + game.turnDirection + game.players.length) % game.players.length;

                    transaction.update(gameRef, {
                        players: game.players,
                        deck: game.deck,
                        discardPile: game.discardPile,
                        turn: game.players[nextPlayerIndex].id,
                        messages: arrayUnion(`${game.players[playerIndex].name} drew a card and passed the turn.`),
                    });
                });
             } catch (error) {
                console.error("Error drawing card:", error);
                showModal("Error", "Could not draw card. " + error.message);
             }
        };
        
        // --- RENDERING ---
        
        const renderLobby = (message = "") => {
            document.getElementById('game-active-area').classList.add('hidden');
            const savedName = localStorage.getItem('uno_player_name') || '';
            document.getElementById('game-container').innerHTML = `
                <div class="p-6 bg-white rounded-xl shadow-lg w-full max-w-lg mx-auto">
                    <h3 class="text-xl font-bold mb-4 text-indigo-600">El Teu Nom</h3>
                    <input type="text" id="player-name-input" maxlength="15" placeholder="Nom de jugador" value="${savedName}" class="w-full p-3 border-2 border-indigo-300 rounded-lg mb-6 focus:ring-indigo-500 focus:border-indigo-500 text-center text-xl font-semibold">

                    <h3 class="text-2xl font-bold mb-4 text-indigo-600">Unir-se a Partida</h3>
                    <input type="text" id="join-game-input" maxlength="4" placeholder="Codi de 4 d√≠gits" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500 text-center text-xl font-mono tracking-widest">
                    <button id="join-button" class="w-full py-3 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 mb-8">Unir-se</button>

                    <h3 class="text-2xl font-bold mb-4 text-indigo-600">Crear Partida</h3>
                    <button id="create-button" class="w-full py-3 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300">Crear Partida Nova</button>
                    <p class="mt-4 text-sm text-red-600 font-semibold">${message}</p>
                </div>`;
            
            const handleAction = (action, gameIdInput = null) => {
                const name = document.getElementById('player-name-input').value;
                if (!name.trim()) {
                    showModal("Error", "Si us plau, introdueix un nom de jugador.");
                    return;
                }
                localStorage.setItem('uno_player_name', name);
                if (action === 'join') {
                    joinGame(gameIdInput, name);
                } else if (action === 'create') {
                    createGame(name);
                }
            };

            document.getElementById('join-button').onclick = () => handleAction('join', document.getElementById('join-game-input').value);
            document.getElementById('create-button').onclick = () => handleAction('create');
        };
        
        const renderGame = (game) => {
            if (game.status === 'lobby') {
                document.getElementById('game-active-area').classList.add('hidden');
                renderLobbyContent(game);
                return;
            }
            
            document.getElementById('game-active-area').classList.remove('hidden');
            document.getElementById('game-container').innerHTML = '';

            const myPlayer = game.players.find(p => p.id === userId);
            const isMyTurn = game.turn === userId;

            // Render Status
            let statusText = '';
            if (game.status === 'playing') {
                const turnPlayer = game.players.find(p => p.id === game.turn);
                statusText = `Torn de: ${turnPlayer.name}`;
            } else if (game.status === 'finished_hand') {
                statusText = `Ronda finalitzada!`;
            } else if (game.status === 'finished') {
                const winner = game.players.find(p => p.id === game.winnerId);
                statusText = `Joc finalitzat! Guanyador: ${winner.name}`;
            }
            document.getElementById('game-status').innerHTML = `<span class="px-4 py-2 rounded-full font-bold bg-gray-200 text-gray-800 text-sm">${statusText}</span>`;

            // Render Piles
            document.getElementById('draw-pile-count').textContent = game.deck.length;
            const topDiscard = game.discardPile[game.discardPile.length - 1];
            const discardPileEl = document.getElementById('discard-pile');
            const discardContainerEl = document.getElementById('discard-pile-container');
            
            discardPileEl.className = `uno-card card-sm card-${topDiscard.color}`;
            discardPileEl.innerHTML = `<span class="card-symbol">${topDiscard.value.replace('_', ' ')}</span> ${getCardDisplayValue(topDiscard)}`;
            discardContainerEl.className = `p-1 rounded-lg border-4 card-${game.currentColor}`;

            // Render My Hand
            document.getElementById('my-player-name').textContent = `La Teva M√† (${myPlayer.name})`;
            const myHandEl = document.getElementById('my-hand');
            myHandEl.innerHTML = myPlayer.hand.map((card, index) => {
                const playable = isMyTurn && isCardPlayable(card, topDiscard, game.currentColor);
                return `
                    <div class="uno-card card-${card.color} ${playable ? 'playable' : ''}" onclick="window.gameFunctions.playCard(${index})">
                       <span class="card-symbol">${card.value.replace('_', ' ')}</span> ${getCardDisplayValue(card)}
                    </div>`;
            }).join('');
            
            // Render Opponents
            const opponentsAreaEl = document.getElementById('opponents-area');
            opponentsAreaEl.innerHTML = game.players.filter(p => p.id !== userId).map(p => `
                <div class="flex flex-col items-center p-2 rounded-lg ${p.id === game.turn ? 'current-player-indicator' : ''}">
                    <p class="font-bold mb-2">${p.name}</p>
                    <div class="flex">
                        <div class="uno-card card-back card-sm"></div>
                        <span class="text-2xl font-bold ml-2">x ${p.hand.length}</span>
                    </div>
                </div>
            `).join('');

            // Render Scores
            const scoreboardEl = document.getElementById('all-players-score');
            scoreboardEl.innerHTML = game.players.map(p => `
                 <div class="p-3 rounded-xl border-2 shadow-sm ${p.id === userId ? 'bg-indigo-100' : 'bg-gray-100'}">
                     <p class="font-bold text-lg">${p.name} ${p.id === userId ? '(Tu)' : ''}</p>
                     <p class="text-sm">Puntuaci√≥: <span class="text-xl text-indigo-700">${p.score}</span></p>
                 </div>
            `).join('');

            // Action Area
            const actionAreaEl = document.getElementById('action-area');
            if (isMyTurn) {
                actionAreaEl.innerHTML = `<p class="text-lg font-bold text-green-700 p-2 border border-green-200 rounded-lg bg-green-100 animate-pulse">√âs el teu torn!</p>`;
            } else {
                 actionAreaEl.innerHTML = `<p class="text-lg font-bold text-orange-700 p-2">Esperant...</p>`;
            }
        };

        const renderLobbyContent = (game) => {
            const container = document.getElementById('game-container');
            const creator = game.players[0];
            const isCreator = userId === creator.id;
            const canStart = game.players.length >= 2;

            container.innerHTML = `
                <div class="p-6 bg-white rounded-xl shadow-lg w-full max-w-lg mx-auto border-t-4 border-blue-500">
                    <p class="text-lg font-bold mb-2">Codi de Partida: <span class="text-3xl font-extrabold select-all text-red-600 bg-red-100 p-1 rounded">${gameId}</span></p>
                    <p>Jugadors: ${game.players.length} / ${game.maxPlayers}</p>
                    <p class="mt-2">${game.players.map(p => p.name).join(', ')}</p>
                    ${isCreator && canStart ? 
                        `<button onclick="window.gameFunctions.startGame()" class="w-full py-3 mt-4 bg-green-500 text-white font-semibold rounded-lg">Iniciar Partida</button>` :
                        `<p class="mt-4 text-center text-gray-600">${isCreator ? "Esperant que s'uneixi un altre jugador..." : "Esperant que el creador inici√Ø la partida."}</p>`
                    }
                </div>
            `;
        };
        
        const getCardDisplayValue = (card) => {
            switch(card.value) {
                case 'skip': return 'üö´';
                case 'reverse': return 'üîÑ';
                case 'draw2': return '+2';
                case 'wild': return 'üé®';
                case 'wild_draw4': return '+4';
                default: return card.value;
            }
        };

        const showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('custom-modal').classList.remove('hidden');
        };

        const closeModal = () => {
            document.getElementById('custom-modal').classList.add('hidden');
        };

        window.gameFunctions = {
            createGame, joinGame, startGame, playCard, drawCardFromPile, chooseColor, closeModal
        };

        initFirebase();
    </script>
</body>
</html>